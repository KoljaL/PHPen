<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Monaco editor</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" fileContent-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/editor/editor.main.min.css">
</head>

<body>

    <header>
        <nav>
            <lable>Filename
                <input type=text>
            </lable>
            <button id=ExecuteButton>RUN</button>
            <lable>select File
                <select id="fileSelect"></select>
            </lable>
        </nav>
    </header>
    <main style="display:flex">
        <div id="MonacoEditor"></div>
        <div id=devider>&nbsp;</div>
        <iframe id=iframe src="./files/_output.php" style="flex: 1 1 0%;" frameborder="0"></iframe>
    </main>
    <footer>
        <div class="withLove">
            <a href="https://github.com/KoljaL/PHPen" title="Link to Github Repository" target="_blank">
        Made with
        <svg viewBox="0 0 1792 1792" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
          <path fill="#8E1B1B" d="M896 1664q-26 0-44-18l-624-602q-10-8-27.5-26T145 952.5 77 855 23.5 734 0 596q0-220 127-344t351-124q62 0 126.5 21.5t120 58T820 276t76 68q36-36 76-68t95.5-68.5 120-58T1314 128q224 0 351 124t127 344q0 221-229 450l-623 600q-18 18-44 18z"></path>
        </svg>
        by
        <img src="https://rasal.de/img/PHPen-15.png" alt="PHPen">
      </a>
        </div>
    </footer>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
    <script>
        //
        // define elements
        //
        var iframe = document.getElementById('iframe');
        var fileSelect = document.getElementById('fileSelect');
        var ExecuteButton = document.getElementById('ExecuteButton');
        var editorValue;



        document.addEventListener('DOMContentLoaded', function() {
            // Query the element
            const resizer = document.getElementById('devider');
            const leftSide = resizer.previousElementSibling;
            const rightSide = resizer.nextElementSibling;

            // The current position of mouse
            let x = 0;
            let y = 0;
            let leftWidth = 0;

            // Handle the mousedown event
            // that's triggered when user drags the resizer
            const mouseDownHandler = function(e) {
                // Get the current mouse position
                x = e.clientX;
                y = e.clientY;
                leftWidth = leftSide.getBoundingClientRect().width;

                // Attach the listeners to `document`
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            };

            const mouseMoveHandler = function(e) {
                // How far the mouse has been moved
                const dx = e.clientX - x;
                const dy = e.clientY - y;

                const newLeftWidth = ((leftWidth + dx) * 100) / resizer.parentNode.getBoundingClientRect().width;
                leftSide.style.width = `${newLeftWidth}%`;

                resizer.style.cursor = 'col-resize';
                document.body.style.cursor = 'col-resize';

                leftSide.style.userSelect = 'none';
                leftSide.style.pointerEvents = 'none';

                rightSide.style.userSelect = 'none';
                rightSide.style.pointerEvents = 'none';
            };

            const mouseUpHandler = function() {
                resizer.style.removeProperty('cursor');
                document.body.style.removeProperty('cursor');

                leftSide.style.removeProperty('user-select');
                leftSide.style.removeProperty('pointer-events');

                rightSide.style.removeProperty('user-select');
                rightSide.style.removeProperty('pointer-events');

                // Remove the handlers of `mousemove` and `mouseup`
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };

            // Attach the handler
            resizer.addEventListener('mousedown', mouseDownHandler);
        });


        const mouseUpHandler = function() {
            resizer.style.removeProperty('cursor');
            document.body.style.removeProperty('cursor');

            leftSide.style.removeProperty('user-select');
            leftSide.style.removeProperty('pointer-events');

            rightSide.style.removeProperty('user-select');
            rightSide.style.removeProperty('pointer-events');

            // Remove the handlers of `mousemove` and `mouseup`
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
        };


        function loadEditor(fileContent) {
            require.config({
                paths: {
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs'
                }
            });
            require(["vs/editor/editor.main"], () => {
                const editor = monaco.editor.create(document.getElementById("MonacoEditor"), {
                    value: fileContent,
                    // value: `< ?php echo date("l jS \of F Y h:i:s A");`,
                    language: 'php',
                    lineNumbers: "on",
                    roundedSelection: true,
                    scrollBeyondLastLine: true,
                    readOnly: false,
                    minimap: {
                        enabled: false
                    },
                    automaticLayout: true,
                    contextmenu: true,
                    fontSize: 12,
                    scrollbar: {
                        useShadows: false,
                        vertical: "visible",
                        horizontal: "visible",
                        horizontalScrollbarSize: 12,
                        verticalScrollbarSize: 12
                    },
                    theme: 'vs-dark',
                });
                editorValue = editor.getValue()

                editor.onDidChangeModelContent(() => {
                    editorValue = editor.getValue();
                });
            });
        }


        function getFile(file) {
            fetch('./handle.php?getContent=' + file)
                .then((response) => response.json())
                .then((fileContent) => {
                    // console.log(fileContent);
                    loadEditor(fileContent);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function getFileList() {
            fetch('./handle.php?fileList')
                .then((response) => response.json())
                .then((fileList) => {
                    // console.log(fileList);
                    fileSelect.innerHTML = fileList;
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
        getFileList();
        getFile('default.php');


        fileSelect.addEventListener("change", (element) => {
            console.log(element.target.value)
            const file = element.target.value;
            getFile(file);
        });



        //
        // style iframe on load $ reload
        //
        window.addEventListener('load', styleIframe);
        iframe.addEventListener('load', styleIframe, true)

        //
        // execute code on button click
        //
        ExecuteButton.addEventListener('click', executeCode);

        //
        // execute code on shortcut ctrl + enter
        //
        window.addEventListener("keyup", (evt) => {
            if (evt.key === "Enter" && evt.ctrlKey) {
                executeCode();
            }
        });





        function styleIframe() {
            iframe.contentDocument.body.style.backgroundColor = "#1E1E1E";
            iframe.contentDocument.body.style.color = "#AEAFAD";
            iframe.contentDocument.body.style.fontFamily = "monospace";
            iframe.contentDocument.body.style.fontSize = "16px";
            iframe.contentDocument.body.style.whiteSpace = "pre-wrap";
        }


        function executeCode() {
            fetch('handle.php?execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editorValue),
                })
                .then((response) => response.json())
                .then((fileContent) => {
                    // console.log(fileContent);
                    iframe.contentDocument.location.reload(true);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    </script>


</body>
<style>
    main {
        display: flex;
    }
    
    iframe,
    #MonacoEditor {
        width: calc((var(--width) - 35px) / 2);
        /* max-width: calc((100vw - 35px) / 2); */
        height: calc(100vh - var(--header-height) - var(--footer-height));
        border: 1px solid black;
        border-radius: 10px;
    }
    
    #devider {
        width: 25px;
        height: calc(100vh - var(--header-height));
        cursor: grab;
    }
    
    body>footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 25px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        background: var(--footer-bg-color);
    }
    
    footer .withLove {
        position: relative;
        bottom: 1px;
        right: 1rem;
    }
    
    footer .withLove a {
        font-size: .8rem;
        color: var(--text-color)
    }
    
    footer .withLove img {
        position: relative;
        bottom: 2px;
    }
    
    footer .withLove svg {
        height: 0.7rem;
        position: relative;
        top: 2px;
    }
</style>

</html>